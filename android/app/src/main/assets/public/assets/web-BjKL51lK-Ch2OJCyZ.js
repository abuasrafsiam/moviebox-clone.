import{W as P}from"./index-qz6UTa08.js";class R extends P{constructor(){super(...arguments),this.lastProgressUpdate=0,this.PROGRESS_UPDATE_INTERVAL=100}async downloadFile(e){try{const t=this.buildUrl(e.url,e.params),s=new Headers(e.headers),o={method:e.method||"GET",headers:s,redirect:e.disableRedirects?"manual":"follow"},r=new AbortController,l=e.connectTimeout||6e4,i=setTimeout(()=>r.abort(),l);let n,a=0;try{const d=await fetch(t,{...o,signal:r.signal});if(!d.ok)throw new Error(`HTTP error: ${d.status}`);if(e.progress&&d.body){const h=d.body.getReader(),f=parseInt(d.headers.get("content-length")||"0",10),F=d.headers.get("content-type")||"";let u=0;const w=[];for(;;){const{done:m,value:g}=await h.read();if(m)break;g&&(w.push(g),u+=g.length,this.notifyProgress(e.url,u,f,f>0,"download"))}const y=new Uint8Array(u);let b=0;for(const m of w)y.set(m,b),b+=m.length;n=new Blob([y],{type:F}),a=u,e.progress&&this.notifyProgress(e.url,a,a,!0,"download",!0)}else n=await d.blob(),a=n.size}finally{clearTimeout(i)}if(await this.tryWriteToFilesystem(n,e.path))return{path:e.path,blob:n};const c=URL.createObjectURL(n),p=document.createElement("a");return p.href=c,p.download=this.extractFilename(e.path,e.url),document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(c),{blob:n,path:e.path}}catch(t){throw this.handleError(t,e.url,e.path)}}async uploadFile(e){try{let t;if(e.blob)t=e.blob;else{const s=await this.tryReadFromFilesystem(e.path);if(s)t=s;else throw new Error("File upload from path is not supported in web without @capacitor/filesystem plugin. Please provide a blob instead.")}return new Promise((s,o)=>{const r=new XMLHttpRequest,l=this.buildUrl(e.url,e.params);e.progress&&(r.upload.onprogress=a=>{this.notifyProgress(e.url,a.loaded,a.total,a.lengthComputable,"upload")}),r.onload=()=>{if(r.status>=200&&r.status<300){e.progress&&this.notifyProgress(e.url,t.size,t.size,!0,"upload",!0);const a={};r.getAllResponseHeaders().split(`\r
`).forEach(c=>{const[p,d]=c.split(": ");p&&d&&(a[p]=d)}),s({bytesSent:t.size,responseCode:r.status.toString(),response:r.responseText,headers:a})}else o(new Error(`HTTP error: ${r.status}`))},r.onerror=()=>{o(new Error("Network error occurred"))},r.open(e.method||"POST",l,!0),e.headers&&Object.entries(e.headers).forEach(([a,c])=>{r.setRequestHeader(a,c)});const i=new FormData,n=e.fileKey||"file";i.append(n,t,e.path),e.params&&Object.entries(e.params).forEach(([a,c])=>{Array.isArray(c)?c.forEach(p=>i.append(a,p)):i.append(a,c)}),r.send(i)})}catch(t){throw this.handleError(t,e.path,e.url)}}buildUrl(e,t){if(!t||Object.keys(t).length===0)return e;const s=new URL(e);return Object.entries(t).forEach(([o,r])=>{Array.isArray(r)?r.forEach(l=>s.searchParams.append(o,l)):s.searchParams.append(o,r)}),s.toString()}notifyProgress(e,t,s,o,r,l=!1){const i=Date.now();if(l||i-this.lastProgressUpdate>=this.PROGRESS_UPDATE_INTERVAL){const n={type:r,url:e,bytes:t,contentLength:s,lengthComputable:o};this.notifyListeners("progress",n),this.lastProgressUpdate=i}}handleError(e,t,s){return e instanceof TypeError&&e.message==="Failed to fetch"?{code:"OS-PLUG-FLTR-0008",message:"Failed to connect to server",source:t,target:s}:e instanceof Error?{code:"OS-PLUG-FLTR-0011",message:e.message,source:t,target:s}:{code:"OS-PLUG-FLTR-0011",message:"An unknown error occurred",source:t,target:s}}extractFilename(e,t){const s=e.split("?")[0].split("#")[0].split(/[/\\]/);let o=s[s.length-1];if(!o.includes(".")){const r=t.split(".");if(r.length>1){const l=r[r.length-1].split("?")[0];o=`${r[r.length-2].split("/").pop()}.${l}`}}return o||(o="download"),o}isFilesystemAvailable(){var e,t;try{return!!((t=(e=globalThis==null?void 0:globalThis.Capacitor)==null?void 0:e.Plugins)!=null&&t.Filesystem)}catch{return!1}}async tryReadFromFilesystem(e){var t,s;if(!this.isFilesystemAvailable())return null;try{const o=(s=(t=window.Capacitor)==null?void 0:t.Plugins)==null?void 0:s.Filesystem;if(!o)return null;const r=(await o.readFile({path:e})).data;if(!r)throw new Error("No data returned from Filesystem plugin");const l=this.getMimeTypeFromPath(e)||"application/octet-stream",i=atob(r),n=[];for(let a=0;a<i.length;a+=512){const c=i.slice(a,a+512),p=new Array(c.length);for(let h=0;h<c.length;h++)p[h]=c.charCodeAt(h);const d=new Uint8Array(p);n.push(d)}return new Blob(n,{type:l})}catch(o){return console.error("Error reading file from Filesystem:",o),null}}async tryWriteToFilesystem(e,t){var s,o;if(!this.isFilesystemAvailable())return!1;try{const r=(o=(s=window.Capacitor)==null?void 0:s.Plugins)==null?void 0:o.Filesystem;if(!r)return!1;const l=await this.blobToBase64(e);if(!l)throw new Error("Failed to convert blob to base64");const i=t.split("/");if(i.length>1){const n=i.slice(0,-1).join("/");await r.stat({path:n}).catch(async()=>{await r.mkdir({path:n,recursive:!0})})}return await r.writeFile({path:t,data:l.split(",")[1],recursive:!0}),!0}catch(r){return console.error("Error writing file to Filesystem:",r),!1}}blobToBase64(e){return new Promise((t,s)=>{const o=new FileReader;o.onload=()=>t(o.result),o.onerror=()=>s(new Error("Failed to convert blob to base64")),o.readAsDataURL(e)})}getMimeTypeFromPath(e){var s;const t=(s=e.split(".").pop())==null?void 0:s.toLowerCase();return t&&{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",pdf:"application/pdf",txt:"text/plain",html:"text/html",htm:"text/html",json:"application/json",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",zip:"application/zip",mp3:"audio/mpeg",mp4:"video/mp4",wav:"audio/wav",xml:"application/xml",csv:"text/csv"}[t]||null}}export{R as FileTransferWeb};
